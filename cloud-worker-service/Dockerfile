FROM segment/chamber:2 AS chamber

FROM ubuntu:latest

COPY --from=chamber /chamber /bin/chamber

WORKDIR /app
COPY /target/x86_64-unknown-linux-gnu/release/cloud-worker-service ./
COPY /cloud-worker-service/config/worker-service.toml ./config/worker-service.toml
COPY /cloud-worker-service/db ./db

RUN apt-get update && apt-get install -y libssl-dev
RUN apt-get update && apt-get install -y ca-certificates
RUN update-ca-certificates

ARG ENVIRONMENT
ARG WORKSPACE
ARG CLOUD_SERVICE_HOST
ARG COMPONENT_SERVICE_HOST
ARG SHARD_MANAGER_HOST
ARG REDIS_DATABASE
ARG REDIS_KEY_PREFIX

ENV ENVIRONMENT=$ENVIRONMENT
ENV AWS_REGION="us-east-1"
ENV GOLEM__COMPONENT_SERVICE__HOST=$COMPONENT_SERVICE_HOST
ENV GOLEM__COMPONENT_SERVICE__PORT=9090
ENV GOLEM__CLOUD_SERVICE__HOST=$CLOUD_SERVICE_HOST
ENV GOLEM__CLOUD_SERVICE__PORT=9090
ENV GOLEM__ROUTING_TABLE__HOST=$SHARD_MANAGER_HOST
ENV GOLEM__ROUTING_TABLE__PORT=9001
ENV GOLEM__TRACING__STDOUT__JSON=true
ENV GOLEM__ENVIRONMENT=$ENVIRONMENT
ENV GOLEM__GATEWAY_SESSION_STORAGE__TYPE="Redis"
ENV GOLEM__GATEWAY_SESSION_STORAGE__CONFIG__PORT=6379
ENV GOLEM__GATEWAY_SESSION_STORAGE__CONFIG__DATABASE=$REDIS_DATABASE
ENV GOLEM__GATEWAY_SESSION_STORAGE__CONFIG__KEY_PREFIX=$REDIS_KEY_PREFIX
ENV GOLEM__WORKSPACE=$WORKSPACE
ENV GOLEM__DB__TYPE="Postgres"
ENV GOLEM__DB__CONFIG__SCHEMA=$WORKSPACE
ENV GOLEM__DB__CONFIG__PORT=5432
ENV RUST_LOG="debug,actix_web=warn,h2=warn,hyper=warn,tower=warn"
ENV RUST_BACKTRACE=1
ENV GOLEM__PORT=9000
ENV GOLEM__CUSTOM_REQUEST_PORT=9001
ENV GOLEM__WORKER_GRPC_PORT=9091
ENV GOLEM__BLOB_STORAGE__TYPE="S3"
ENV GOLEM__BLOB_STORAGE__CONFIG__REGION=us-east-1
ENV GOLEM__BLOB_STORAGE__CONFIG__OBJECT_PREFIX="${COMPONENT_STORE_OBJECT_PREFIX}"
ENV GOLEM__BLOB_STORAGE__CONFIG__USE_MINIO_CREDENTIALS=false
ENV GOLEM__BLOB_STORAGE__CONFIG__RETRIES__MAX_ATTEMPTS=3
ENV GOLEM__BLOB_STORAGE__CONFIG__RETRIES__MIN_DELAY="100ms"
ENV GOLEM__BLOB_STORAGE__CONFIG__RETRIES__MAX_DELAY="1s"
ENV GOLEM__BLOB_STORAGE__CONFIG__RETRIES__MULTIPLIER="3.0"

EXPOSE 9000
EXPOSE 9001
EXPOSE 9091
RUN chmod +x cloud-worker-service

COPY cloud-worker-service/cloud-worker-service-wrapper.sh cloud-worker-service-wrapper.sh
RUN chmod +x cloud-worker-service-wrapper.sh
ENTRYPOINT ["./cloud-worker-service-wrapper.sh"]

